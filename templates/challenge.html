{% extends "base.html" %}
{% block content %}

<h2>Aktive Challenge</h2>

{% if message %}
  <p class="blocked">{{ message }}</p>
{% endif %}

{% if challenge %}
  <p><strong>Team:</strong> {{ team }}</p>
  <p><strong>Challenge:</strong> {{ challenge.title }}</p>

  {% if status == "RUNNING" %}
    <p class="timer">⏱ Restzeit: <span id="timer"></span></p>
  {% elif status == "FINISHED" %}
    <p class="blocked">⛔ Zeit abgelaufen</p>
  {% endif %}

  <ul>
  {% for task in tasks %}
    <li>
      <strong>{{ task.title }}</strong><br>
      {{ task.description }}<br>
      <em>Max Punkte: {{ task.max_points }}</em><br><br>

      {% if status == "RUNNING" %}
        {% if task.id in submitted_task_ids %}
          <span class="ok">✅ Abgabe erfolgt</span>
        {% else %}
          <form method="post"
                action="/submit/{{ task.id }}"
                enctype="multipart/form-data">

            <input type="file"
                   name="file"
                   accept=".pde"
                   onchange="validateFile(this, {{ task.id }})"
                   required>

            <br>
            <button type="submit"
                    id="submit-btn-{{ task.id }}"
                    disabled>
              Abgeben
            </button>
          </form>
        {% endif %}
      {% else %}
        <span class="blocked">⛔ Keine Abgabe möglich</span>
      {% endif %}
    </li>
  {% endfor %}
  </ul>
{% endif %}

{% if status == "RUNNING" %}
<script>
let remaining = {{ remaining }};
const timer = document.getElementById("timer");

function updateTimer() {
  if (remaining <= 0) {
    timer.innerText = "00:00";
    location.reload();
    return;
  }
  const min = Math.floor(remaining / 60);
  const sec = remaining % 60;
  timer.innerText =
    String(min).padStart(2, '0') + ":" + String(sec).padStart(2, '0');
  remaining--;
}

updateTimer();
setInterval(updateTimer, 1000);

function validateFile(input, taskId) {
  const btn = document.getElementById("submit-btn-" + taskId);
  if (!input.files.length) {
    btn.disabled = true;
    return;
  }
  const name = input.files[0].name.toLowerCase();
  if (name.endsWith(".pde")) {
    btn.disabled = false;
  } else {
    alert("Bitte eine .pde-Datei auswählen");
    input.value = "";
    btn.disabled = true;
  }
}
</script>
{% endif %}

{% endblock %}
